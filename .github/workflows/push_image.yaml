name: push_image
on:
  workflow_call:
    inputs:
      image_tag:
        description: docker image tags
        default: latest
        required: false
        type: string
      dockerhub_name:
        description: docker hub name
        default: changeme
        required: true
        type: string
      dockerhub_password:
        description: docker hub password
        default: changeme
        required: true
        type: string
jobs:
  docker:
    name: build and push latest image
    runs-on: ubuntu-latest
    env:
      GOVER: ^1.17.5
    steps:
      - name: Set up Go ${{env.GOVER}}
        uses: actions/setup-go@v2.1.4
        with:
          go-version: ${{ env.GOVER }}
      - name: Check out code into the Go module directory
        uses: actions/checkout@v2
      - name: Run make go.mod check-diff
        run: git diff --exit-code ./go.mod
      - name: Codecov
        uses: codecov/codecov-action@v1
      - name: Run make release
        run: |
          make release GOOS=linux GOARCH=amd64
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{inputs.dockerhub_name}}
          password: ${{inputs.dockerhub_password}}
      - name: build dev-container DOCKER_TAG=${{inputs.image_tag}}
        run: make build-dev-container
